{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Detailed Chip Package Definition",
  "description": "Defines properties of a chip package, including precise physical layout for script-driven rendering, pin characteristics, and peripheral mapping.",
  "type": "object",
  "properties": {
    "partInfo": {
      "type": "object",
      "description": "Basic information about the chip part and package.",
      "properties": {
        "partNumber": { "type": "string", "description": "Manufacturer part number." },
        "packageType": { "type": "string", "description": "e.g., QFN-48, WLCSP-35." },
        "datasheetVersion": { "type": "string", "description": "Version of the datasheet this definition is based on." },
        "sizeDescription": { "type": "string", "description": "Overall physical dimensions (e.g., '7mm x 7mm x 0.85mm body')." }
      },
      "required": ["partNumber", "packageType"]
    },
    "renderConfig": {
      "type": "object",
      "description": "Parameters for rendering the package in the application.",
      "properties": {
        "canvasDefaults": {
          "type": "object",
          "properties": {
            "padding": { "type": "number", "default": 20, "description": "Default padding around the package within the canvas, in 'units' or pixels if units are abstract." }
          },
          "required": ["padding"]
        },
        "chipBody": {
          "type": "object",
          "description": "Visual and dimensional properties of the chip body.",
          "properties": {
            "width": { "type": "number", "description": "Width of the chip body in 'units'." },
            "height": { "type": "number", "description": "Height of the chip body in 'units'." },
            "centerX": { "type": "number", "default": 0, "description": "X-coordinate of the chip body's center (application can define origin, e.g., canvas center)." },
            "centerY": { "type": "number", "default": 0, "description": "Y-coordinate of the chip body's center." },
            "cornerRadius": { "type": "number", "default": 0, "description": "Corner radius if shape is 'rect', in 'units'." },
            "fillColor": { "type": "string", "format": "color", "default": "#4A4A4A" },
            "strokeColor": { "type": "string", "format": "color", "default": "#222222" },
            "strokeWidth": { "type": "number", "default": 0.5, "description": "in 'units' or pixels" },
            "orientationMarker": {
                "type": "object",
                "description": "Visual marker for pin 1 or package orientation.",
                "properties": {
                    "size": {"type": "number", "description": "Diameter or length of the marker in 'units'."},
                    "offsetX": {"type": "number", "description": "X offset from chipBody centerX in 'units'."},
                    "offsetY": {"type": "number", "description": "Y offset from chipBody centerY in 'units'."},
                    "fillColor": {"type": "string", "format": "color", "default": "#FFFFFF"}
                }
            }
          },
          "required": ["width", "height"]
        },
        "pinDefaults": {
          "type": "object",
          "description": "Default visual properties for all pins. Can be overridden per pin.",
          "properties": {
            "shape": { "enum": ["rect", "circle"], "default": "rect" },
            "width": { "type": "number", "description": "Default width/diameter of a pin in 'units'." },
            "height": { "type": "number", "description": "Default height of a pin (if applicable, e.g., for rects) in 'units'." },
            "fillColor": { "type": "string", "format": "color", "default": "#B0B0B0" },
            "strokeColor": { "type": "string", "format": "color", "default": "#707070" },
            "strokeWidth": { "type": "number", "default": 0.2, "description": "in 'units' or pixels" }
          },
          "required": ["shape", "width"]
        },
        "layoutStrategy": {
          "type": "object",
          "description": "Strategy for positioning pins.",
          "oneOf": [
            { "$ref": "#/definitions/quadPerimeterLayout" },
            { "$ref": "#/definitions/gridMatrixLayout" },
            { "$ref": "#/definitions/customExplicitLayout" }
          ]
        }
      },
      "required": ["canvasDefaults", "chipBody", "pinDefaults", "layoutStrategy"]
    },
    "socPeripherals": {
      "type": "array",
      "description": "Defines the capabilities and requirements of SoC-level peripherals. This information is characteristic of the SoC die itself.",
      "items": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "description": "Unique identifier for this SoC peripheral instance (e.g., 'SPIM0', 'UARTE0', 'TIMER2', 'SAADC')."
          },
          "type": {
            "type": "string",
            "description": "General category of the peripheral (e.g., 'SPI', 'UART', 'I2C', 'TIMER', 'ADC', 'PWM', 'RTC', 'PDM', 'QDEC', 'GPIOTE', 'RADIO', 'TAMPC', 'TRACE')."
          },
          "baseAddress": {
            "type": "string",
            "pattern": "^0x[0-9a-fA-F]{8}$",
            "description": "Base memory address of the peripheral (e.g., '0x4000A000')."
          },
          "description": {
            "type": "string",
            "description": "Brief description of the peripheral's function."
          },
          "uiHint": { "type": "string", "enum": ["normal", "checkbox"], "default": "normal", "description": "A hint for the UI on how to display this peripheral." },
          "signals": {
            "type": "array",
            "description": "Defines the individual signals (pins/lines) this peripheral requires or provides.",
            "items": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string",
                  "description": "Logical name of the signal from the SoC's perspective (e.g., 'SCK', 'MOSI', 'RXD', 'SCL', 'AIN0', 'PWM_OUT0', 'EVENT_CHANNEL_0')."
                },
                "description": { "type": "string" },
                "direction": {
                  "enum": ["input", "output", "inout", "analog_input", "analog_output", "analog_inout"],
                  "description": "Signal direction relative to the SoC peripheral."
                },
                "isMandatory": {
                  "type": "boolean", "default": false,
                  "description": "Is this signal essential for the peripheral's basic operation?"
                },
                "requiresClockCapablePin": {
                  "type": "boolean", "default": false,
                  "description": "Does this signal require connection to a GPIO pin designated as 'clock capable' in the 'pins' array?"
                },
                "allowedGpio": {
                  "type": "array",
                  "items": {
                    "type": "string",
                    "pattern": "^P[0-9]+(?:\\.[0-9]{1,2}|\\*)$",
                    "description": "An SoC-level GPIO specifier. Use format 'P<port>*' (e.g., 'P0*') for all pins in a port, or 'P<port>.<pin>' (e.g., 'P0.01', 'P1.10') for a specific pin. Pin numbers are typically 1 or 2 digits."
                  },
                  "description": "A list of SoC-level GPIO specifiers indicating which GPIOs or GPIO ports a signal can be routed through. This refined list is considered before package-specific pin mappings. For example, ['P0*', 'P1.00', 'P1.01']."
                },
                "driveStrengthRequirement": {
                  "enum": ["standard", "high", "extra high"],
                  "description": "Recommended or required GPIO drive strength if this signal is an output."
                },
                "specialNotes": {
                  "type": "string",
                  "description": "Any special considerations for this signal (e.g., 'Pull-up recommended', 'Requires external components')."
                }
              },
              "required": ["name", "direction"]
            }
          }
        },
        "required": ["id", "type", "signals"]
      }
    },
    "pins": {
      "type": "array",
      "description": "Detailed list of all physical pins on this package.",
      "items": {
        "type": "object",
        "properties": {
          "packagePinId": { "type": "string", "description": "Unique physical identifier on the package (e.g., '1', '48', 'A1', 'G7')." },
          "name": { "type": "string", "description": "Logical SoC signal name (e.g., 'P0.01', 'VDD', 'NC')." },
          "port": { "type": ["string", "null"], "description": "GPIO port for GPIO pins, e.g., 'P0', 'P1'." },
          "pinIndex": { "type": ["integer", "null"], "description": "Index of the pin within its port for GPIO pins." },
          "functions": {
            "type": "array",
            "description": "List of functions available on this pin. E.g., ['AIN0', 'PWM_OUT2', 'GPIO'].",
            "items": { "type": "string" }
          },
          "defaultType": { "enum": ["io", "power_positive", "power_ground", "analog_special", "debug", "reset", "crystal_hf", "crystal_lf", "rf_antenna", "rf_control", "decoupling", "nc", "other_system"], "description": "Primary classification." },
          "isClockCapable": { "type": "boolean", "default": false },
          "powerDomain": { "type": "string" },
          "renderOrder": { "type": "integer", "description": "For perimeter layouts, the sequential drawing order if 'packagePinId' is not numeric/sequential." },
          "side": { "enum": ["top", "bottom", "left", "right"], "description": "For perimeter layouts, which side the pin is on." },
          "gridCoordinates": { "type": "string", "description": "For grid layouts, e.g., 'A1', 'H12'."},
          "x": { "type": "number", "description": "Explicit X coordinate (center) in 'units', for 'customExplicitLayout' or to override calculated." },
          "y": { "type": "number", "description": "Explicit Y coordinate (center) in 'units'." },
          "rotation": { "type": "number", "default": 0, "description": "Rotation in degrees (0 is typically pointing outwards for perimeter pins)." },
          "shape": { "type": "string", "description": "Overrides pinDefaults.shape." },
          "width": { "type": "number", "description": "Overrides pinDefaults.width." },
          "height": { "type": "number", "description": "Overrides pinDefaults.height." },
          "length": { "type": "number", "description": "Overrides pinDefaults.length." },
          "fillColor": { "type": "string", "format": "color" },
          "strokeColor": { "type": "string", "format": "color" },
          "strokeWidth": { "type": "number" }
        },
        "required": ["packagePinId", "name", "defaultType"]
      }
    }
  },
  "required": ["partInfo", "renderConfig", "pins"],
  "definitions": {
    "quadPerimeterLayout": {
      "type": "object",
      "properties": {
        "layoutType": { "const": "quadPerimeter" },
        "pinCounts": {
          "type": "object",
          "description": "Number of pins on each side.",
          "properties": {
            "top": { "type": "integer", "default": 0 },
            "bottom": { "type": "integer", "default": 0 },
            "left": { "type": "integer", "default": 0 },
            "right": { "type": "integer", "default": 0 }
          },
          "required": ["top", "bottom", "left", "right"]
        },
        "pinPitch": { "type": "number", "description": "Distance between centers of adjacent pins on a side, in 'units'." },
        "numberingStart": {
          "type": "object",
          "properties": {
            "side": { "enum": ["top", "bottom", "left", "right"] },
            "corner": { "enum": ["topLeft", "topRight", "bottomLeft", "bottomRight", "center"], "description": "Relative corner/edge of the side where pin numbering starts." },
            "direction": { "enum": ["clockwise", "counterClockwise"] }
          },
          "required": ["side", "corner", "direction"]
        },
        "pinOffsetFromEdge": { "type": "number", "default": 0, "description": "Distance from the chip body edge to the center of the pin's base, in 'units'." }
      },
      "required": ["layoutType", "pinCounts", "pinPitch", "numberingStart"]
    },
    "gridMatrixLayout": {
      "type": "object",
      "properties": {
        "layoutType": { "const": "gridMatrix" },
        "rows": { "type": "integer" },
        "columns": { "type": "integer" },
        "rowLabels": { "type": "array", "items": { "type": "string" }, "description": "e.g., ['A', 'B', ...]" },
        "columnLabels": { "type": "array", "items": { "type": "string" }, "description": "e.g., ['1', '2', ...]" },
        "pitchX": { "type": "number", "description": "Horizontal distance between pin/ball centers, in 'units'." },
        "pitchY": { "type": "number", "description": "Vertical distance between pin/ball centers, in 'units'." },
        "originOffset": {
          "type": "object",
          "description": "X,Y offset of the center of the first pin (e.g., A1) from the chipBody center (0,0), in 'units'.",
          "properties": {
            "x": { "type": "number" },
            "y": { "type": "number" }
          },
          "required": ["x", "y"]
        },
        "labelOriginConvention": { "enum": ["topLeft", "bottomLeft"], "default": "topLeft", "description": "Defines if 'A1' is the top-left or bottom-left pin of the grid." }
      },
      "required": ["layoutType", "rows", "columns", "pitchX", "pitchY", "originOffset"]
    },
    "customExplicitLayout": {
      "type": "object",
      "properties": {
        "layoutType": { "const": "customCoordinates" },
        "description": { "type": "string", "default": "Pins are positioned using their explicit x, y, rotation properties."}
      },
      "required": ["layoutType"]
    }
  }
}
